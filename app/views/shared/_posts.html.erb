<% if Current.user != nil %>
<% @num = 1 %>
<% @posts.each do |post| %>
  <div class="d-flex flex-column card my-2" style="max-width: 500px;">

    <%# POST HEADERS %>
    <div class="d-flex flex-row  px-3 pt-3" id=header1>
      <img src="<%= id2avatar(post.user_id) %>" width="50" height="50" class="rounded-circle">
      <div class="d-flex flex-column mx-2">
        <h5 class="card-title"><%= id2name(post.user_id) %></h5>
        <p class="text-muted post-card-muted"><%= time_ago_in_words(post.created_at) %> ago</p>
      </div>
    </div>

    <%# POST MESSAGE %>
    <div class="card-body px-3">
      <p class="card-text"><%= "#{post.message}" %></p>
    </div>

    <%# POST IMAGE %>
    <img src="<%= post.image_url %>" class="img-fluid" >

    <%# LIKE AND COMMENT BUTTONS %>
    <div class="class-body post-buttons py-1">
      <button class="like-button post-action-buttons">
        <i class="bi bi-hand-thumbs-up-fill"></i>
      </button>
      <button class="post-action-buttons" type="button" data-bs-toggle="collapse" data-bs-target="#<%= "collapseComment#{@num}"%>" aria-expanded="false" aria-controls="<%= "collapseComment#{@num}"%>">
        <i class="bi bi-chat-right-fill"></i>
      </button>
    </div>


    <%# NEW COMMENT FORM %>
        <div class="card-body d-flex flex-row p-2" id="makeANewComment">
          <img src="<%= id2avatar(post.user_id) %>" width="35" height="35" class="rounded-circle" >
          <div class="d-flex flex-column w-100 mx-1">

              <input type="hidden" id="getFirstName" value="<%= Current.user.first_name %>">
              <input type="hidden" id="getLastName" value="<%= Current.user.last_name %>">
              <input type="hidden" id="getPostId" value="<%= post.id %>">
              <input type="string" class="w-100 form-control" id="commentContent">
              
              <div>
                <button class="post-action-buttons" id="submitComment">
                  <i class="bi bi-chat-right-fill"></i>
                </button>
              </div> 

            <p class="m-0"><small class="text-muted">Press enter to comment</small></p>
          </div>
        </div>
        </div>

      <%# SHOW COMMENTS ON THIS POST %>
        <% post.comments.reverse.each do |comment| %>
          <div class="card-body d-flex flex-row py-1 px-1" id = comment_list>
              <img src="<%= id2avatar(comment.user_id) %>" width="35" height="35" class="rounded-circle" id="avatar" >
              <div>
                <div>
                  <p class="post-comment-display mx-2 p-2">
                    <% find_user_id = comment.user_id %>
                    <% find_user = User.find_by(id: find_user_id) %>
                    <small class="fw-bold comment-title"><%= "#{find_user[:first_name]} #{find_user[:last_name]}" %> </small>
                    <small class="comment-content"><%= comment.message %></small>
                    </p>
                  <font size="1"><%= time_ago_in_words(post.created_at) %> ago</font>
                </div>
              </div>
          </div>
        <%end%>

      <% @num += 1 %>
    <% end %>
  <% end %>


<script type="text/javascript">

let submitComment = document.getElementById("submitComment")
let commentContent = document.getElementById("commentContent")
let getPostId = document.getElementById("getPostId")
let postId = getPostId.value
let getFirstName = document.getElementById("getFirstName")
let getLastName = document.getElementById("getLastName")
let userName = `${getFirstName.value} ${getLastName.value}`
 

let saveComment = () => {
  let data = {"comment": {"post_id": postId, "message": commentContent.value}}
  fetch("http://localhost:3000/comments", {
    method: "POST",
    headers: {
      "Content-Type" : "application/json",
    }, 
    body: JSON.stringify(data)
  })
  .then(() => {

    let div1 = document.createElement("Div")
    div1.className = "card-body d-flex flex-row py-2 px-2"
    let div2 = document.createElement("Div")
    div2.className = "card-body d-flex flex-row py-2 px-2"
    let img = document.getElementById("avatar")
    let cloneImg = img.cloneNode(true)
    div2.appendChild(cloneImg)
    let div3 = document.createElement("Div")
    let p = document.createElement("p")
    p.className = "post-comment-display mx-2 p-2"
    let nameDisplay = document.createElement("small")
    nameDisplay.className = "fw-bold comment-title"
    nameDisplay.innerText = userName
    let contentDisplay = document.createElement("small")
    contentDisplay.className = "comment-content"
    contentDisplay.innerText = commentContent.value
    p.appendChild(nameDisplay)
    p.appendChild(contentDisplay)
    div3.appendChild(p)
    let emptyDiv = document.createElement('div')
    emptyDiv.appendChild(div3)
    div2.appendChild(emptyDiv)
    div1.appendChild(div2)
    let card = document.createElement("div")
    card.className = "class-body"
    card.appendChild(div1)
    let blah = document.getElementById("makeANewComment")
    blah.after(card)
  })
 }

submitComment.addEventListener("click", saveComment)

var input = document.getElementById("commentContent");
input.addEventListener("keyup", function(event) {
    if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("submitComment").click();
        saveComment;
    }
});


function hideSubmitButton() {
  var x = document.getElementById("submitComment");
    x.style.display = "none";
  }

hideSubmitButton();

</script>
